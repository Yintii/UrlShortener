<%= form_tag(short_link_home_path, method: :post, class: "main-page-form", data: { controller: "submit-input" }) do %>
  <div class="action-selector flex row">
    <div id="shrtn-action" data-submit-input-target="shrtnAction" class="active-action">
      <label>
        <%= radio_button_tag :action_type, "shrtn", true, data: { action: "change->submit-input#change", "submit-input-target": "radio" } %>
        Shrtn
      </label>
    </div>
    <div id="qr-action" data-submit-input-target="qrAction">
      <label>
        <%= radio_button_tag :action_type, "qr", false, data: { action: "change->submit-input#change", "submit-input-target": "radio" } %>
        QR Code
      </label>
    </div>
  </div>
  <div class="form-wrapper">
    <%= text_field_tag :link, params[:link], placeholder: "EntrURL2Shrtn", data: { "submit-input-target": "textInput" } %>
  </div>
  <button type="submit" data-submit-input-target="submit">Shrtn</button>
<% end %>

<% if params[:created_short_link] || @short_link %>
  <div id="short-link-wrap">
    <p id="shortened-url">http://yintii.com/<%= params[:created_short_link] || @short_link %></p>
    <button id="copy-btn" onclick="copyLink()">
      <i class="fa-solid fa-copy"></i>
    </button>
  </div>
<% end %>

<% if @qr_code %>
  <div id="qr-code-wrap">
    <%= @qr_code.html_safe %>
    <a id="qr-download-btn" download="qr_code.svg">
      Download QR Code
    </a>
  </div>
<% end %>

<script>
  function copyLink() {
    const urlElement = document.getElementById('shortened-url');
    const button = document.getElementById('copy-btn');
    if (!urlElement) return;
    const url = urlElement.textContent;
    navigator.clipboard.writeText(url).then(() => {
      const originalText = button.innerHTML;
      button.innerHTML = 'Copied!';
      setTimeout(() => { button.innerHTML = originalText; }, 2000);
    }).catch(err => {
      console.error('Failed to copy:', err);
      const tempInput = document.createElement('input');
      tempInput.value = url;
      document.body.appendChild(tempInput);
      tempInput.select();
      document.execCommand('copy');
      document.body.removeChild(tempInput);
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
      const qrWrap = document.getElementById('qr-code-wrap');
      if (qrWrap) {
        const svg = qrWrap.querySelector('svg');
        const downloadBtn = document.getElementById('qr-download-btn');
        if (svg && downloadBtn) {
          const blob = new Blob([svg.outerHTML], { type: 'image/svg+xml' });
          downloadBtn.href = URL.createObjectURL(blob);
        }
      }
  });
</script>